---
# System limits and performance tuning for Autoware
- name: Configure real-time process limits
  become: true
  ansible.builtin.lineinfile:
    path: /etc/security/limits.conf
    line: "{{ item }}"
    state: present
  loop:
    - "* soft rtprio 99"
    - "* hard rtprio 99"
    - "* soft memlock unlimited"
    - "* hard memlock unlimited"

- name: Configure CPU governor for performance
  become: true
  ansible.builtin.shell: |
    if command -v cpupower &> /dev/null; then
      cpupower frequency-set -g performance
    fi
  changed_when: false
  failed_when: false

- name: Disable CPU frequency scaling
  become: true
  ansible.builtin.shell: |
    for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
      if [ -f "$cpu/cpufreq/scaling_governor" ]; then
        echo performance > "$cpu/cpufreq/scaling_governor"
      fi
    done
  changed_when: false
  failed_when: false

- name: Configure swappiness for better performance
  become: true
  ansible.builtin.sysctl:
    name: vm.swappiness
    value: "10"
    state: present
    reload: yes

- name: Configure kernel parameters for real-time
  become: true
  ansible.builtin.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { name: kernel.sched_rt_runtime_us, value: "-1" }
    - { name: kernel.threads-max, value: "1048576" }