---
- name: Autoware System Setup
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    # Fixed paths for our packages
    autoware_dir: /opt/autoware
    config_dir: /opt/autoware
    data_dir: /opt/autoware/data
    
    # Fixed versions
    cuda_version: "12.3"
    cudnn_version: "8.9.7"
    tensorrt_version: "8.6.1"
    rosdistro: "humble"
    rmw_implementation: "rmw_cyclonedds_cpp"
    
    # Options (can be overridden)
    install_nvidia: false
    install_devel: false
    
  pre_tasks:
    - name: Verify OS version
      ansible.builtin.fail:
        msg: "This setup requires Ubuntu 22.04. Current version: {{ ansible_distribution_version }}"
      when: 
        - ansible_distribution != "Ubuntu"
        - ansible_distribution_version != "22.04"
      
    - name: Check if running as root
      ansible.builtin.fail:
        msg: "This playbook should not be run as root. Please run with sudo."
      when: 
        - ansible_user_id == "root"
        - lookup('env', 'ANSIBLE_TEST_MODE') != "true"
      
    - name: Check Autoware packages
      ansible.builtin.command: dpkg -l autoware-full
      changed_when: false
      failed_when: false
      register: autoware_check
      check_mode: no
      
    - name: Warn if Autoware packages not installed
      ansible.builtin.debug:
        msg: "Warning: autoware-full package not found. Please install it first."
      when: autoware_check.rc is defined and autoware_check.rc != 0
      
    - name: Print configuration
      ansible.builtin.debug:
        msg:
          - "ROS Distribution: {{ rosdistro }}"
          - "RMW Implementation: {{ rmw_implementation }}"
          - "Install NVIDIA: {{ install_nvidia }}"
          - "Install Dev Tools: {{ install_devel }}"
          - "CUDA Version: {{ cuda_version }} (if NVIDIA enabled)"
          - "cuDNN Version: {{ cudnn_version }} (if NVIDIA enabled)"
          - "TensorRT Version: {{ tensorrt_version }} (if NVIDIA enabled)"
      
  roles:
    # Always run - core system configuration
    - role: network_setup
      tags: [always, network]
      
    - role: system_limits
      tags: [always, system]
      
    - role: rmw_implementation
      tags: [always, rmw]
      
    - role: build_tools
      tags: [always, build]
      
    - role: autoware_env
      tags: [always, env]
    
    # Conditional - NVIDIA support
    - role: cuda
      when: install_nvidia | bool
      tags: [nvidia, cuda]
      
    - role: tensorrt
      when: install_nvidia | bool
      tags: [nvidia, tensorrt]
      
    # Conditional - Development tools
    - role: dev_tools
      when: install_devel | bool
      tags: [dev, tools]
      
  post_tasks:
    - name: Setup complete
      ansible.builtin.debug:
        msg: 
          - "Autoware setup completed successfully!"
          - "Please run 'source ~/.bashrc' or start a new terminal to apply changes."
          - "Run 'autoware-setup --verify' to check the installation."