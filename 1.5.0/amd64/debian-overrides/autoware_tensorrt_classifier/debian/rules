#!/usr/bin/make -f
# -*- makefile -*-

SHELL := /bin/bash

export DH_VERBOSE=1
export LDFLAGS=
export PKG_CONFIG_PATH=/opt/autoware/1.5.0/lib/pkgconfig

# CUDA environment for TensorRT packages
export CUDA_HOME=/usr/local/cuda
export CMAKE_CUDA_COMPILER=/usr/local/cuda/bin/nvcc
export PATH := /usr/local/cuda/bin:$(PATH)
export LD_LIBRARY_PATH := /usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu:$(LD_LIBRARY_PATH)

export DEB_CFLAGS_MAINT_APPEND=-DNDEBUG -fno-lto
export DEB_CXXFLAGS_MAINT_APPEND=-DNDEBUG -fno-lto
export DEB_LDFLAGS_MAINT_APPEND=-fno-lto
ifneq ($(filter nocheck,$(DEB_BUILD_OPTIONS)),)
	BUILD_TESTING_ARG=-DBUILD_TESTING=OFF
endif

DEB_HOST_GNU_TYPE ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)

COLCON_INSTALL_PATH ?=
ROS_BASE_PATH ?= /opt/ros/humble

ifneq ($(COLCON_INSTALL_PATH),)
	PATH_COLCON = $(COLCON_INSTALL_PATH)
	PATH_INSTALL = /opt/autoware/1.5.0
	PATH_ROS = $(ROS_BASE_PATH)
	SETUP_SCRIPT = $(COLCON_INSTALL_PATH)/local_setup.bash
else
	PATH_COLCON =
	PATH_INSTALL = /opt/autoware/1.5.0
	PATH_ROS = $(ROS_BASE_PATH)
	SETUP_SCRIPT = /opt/autoware/1.5.0/local_setup.bash
endif

export CMAKE_PREFIX_PATH := $(PATH_COLCON):$(PATH_INSTALL):$(PATH_ROS)
export AMENT_PREFIX_PATH := $(PATH_COLCON):$(PATH_INSTALL):$(PATH_ROS)

%:
	dh $@ -v --buildsystem=cmake --builddirectory=.obj-$(DEB_HOST_GNU_TYPE)

override_dh_auto_configure:
	source "$(SETUP_SCRIPT)" 2>/dev/null || true && \
	export CMAKE_PREFIX_PATH="$(PATH_INSTALL):$(PATH_ROS):$$CMAKE_PREFIX_PATH" && \
	export AMENT_PREFIX_PATH="$(PATH_INSTALL):$(PATH_ROS):$$AMENT_PREFIX_PATH" && \
	mkdir -p .obj-$(DEB_HOST_GNU_TYPE) && \
	cd .obj-$(DEB_HOST_GNU_TYPE) && \
	cmake .. \
		-DCMAKE_INSTALL_PREFIX=/opt/autoware/1.5.0 \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_VERBOSE_MAKEFILE=ON \
		-DCMAKE_INSTALL_LIBDIR=lib/$(DEB_HOST_GNU_TYPE) \
		$(BUILD_TESTING_ARG)

override_dh_auto_build:
	source "$(SETUP_SCRIPT)" 2>/dev/null || true && \
	export CMAKE_PREFIX_PATH="$(PATH_INSTALL):$(PATH_ROS):$$CMAKE_PREFIX_PATH" && \
	export AMENT_PREFIX_PATH="$(PATH_INSTALL):$(PATH_ROS):$$AMENT_PREFIX_PATH" && \
	$(MAKE) -C .obj-$(DEB_HOST_GNU_TYPE)

override_dh_auto_test:
	echo "-- Running tests. Even if one of them fails the build is not canceled."
	source "$(SETUP_SCRIPT)" 2>/dev/null || true && \
	export CMAKE_PREFIX_PATH="$(PATH_INSTALL):$(PATH_ROS):$$CMAKE_PREFIX_PATH" && \
	export AMENT_PREFIX_PATH="$(PATH_INSTALL):$(PATH_ROS):$$AMENT_PREFIX_PATH" && \
	$(MAKE) -C .obj-$(DEB_HOST_GNU_TYPE) test || true

override_dh_shlibdeps:
	source "$(SETUP_SCRIPT)" 2>/dev/null || true; \
	dh_shlibdeps --dpkg-shlibdeps-params=--ignore-missing-info $(EXTRA_LIB_PATHS) -l$(CURDIR)/debian/ros-humble-autoware-tensorrt-classifier//opt/autoware/1.5.0/lib/:$(CURDIR)/debian/ros-humble-autoware-tensorrt-classifier//opt/autoware/1.5.0/opt/autoware_tensorrt_classifier/lib/

override_dh_auto_install:
	source "$(SETUP_SCRIPT)" 2>/dev/null || true && \
	export CMAKE_PREFIX_PATH="$(PATH_INSTALL):$(PATH_ROS):$$CMAKE_PREFIX_PATH" && \
	export AMENT_PREFIX_PATH="$(PATH_INSTALL):$(PATH_ROS):$$AMENT_PREFIX_PATH" && \
	DESTDIR=$(CURDIR)/debian/ros-humble-autoware-tensorrt-classifier $(MAKE) -C .obj-$(DEB_HOST_GNU_TYPE) install
