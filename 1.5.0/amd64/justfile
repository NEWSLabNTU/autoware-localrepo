# Autoware 1.5.0 AMD64 Local Repository Builder

# Default recipe: list all available recipes
default:
    @just --list

# Build everything: ROS packages + meta-packages + APT repository
all: ros meta repo
    @echo "✓ Local repository ready in repo/"

# Build ROS packages from Autoware repo (via colcon2deb)
ros:
    #!/usr/bin/env bash
    set -e
    if ! command -v colcon2deb &> /dev/null; then
        echo "Error: colcon2deb is not available."
        echo "Please install it: pip install colcon2deb"
        exit 1
    fi
    colcon2deb --workspace source --config config.yaml

# Build meta-packages
meta:
    @echo "Building meta-packages..."
    cd packages/autoware-localrepo && dpkg-buildpackage -us -uc -b
    cd packages/autoware-config && dpkg-buildpackage -us -uc -b
    cd packages/autoware-theme && dpkg-buildpackage -us -uc -b
    cd packages/autoware-runtime && dpkg-buildpackage -us -uc -b
    cd packages/autoware-full && dpkg-buildpackage -us -uc -b
    @echo "✓ Meta-packages built"

# Create APT repository
repo:
    mkdir -p repo/pool/main
    @echo "Collecting .deb packages..."
    -cp build/dist/*.deb repo/pool/main/ 2>/dev/null
    -cp packages/*.deb repo/pool/main/ 2>/dev/null
    @echo "Generating Packages index..."
    cd repo && dpkg-scanpackages pool/main /dev/null > Packages
    cd repo && gzip -k -f Packages
    @echo "✓ APT repository created in repo/"
    @ls -1 repo/pool/main/*.deb 2>/dev/null | wc -l | xargs -I{} echo "  Total: {} packages"

# Clean all build artifacts
clean:
    @echo "Cleaning..."
    rm -rf build/
    rm -rf repo/
    rm -f packages/*/*.deb packages/*/*.buildinfo packages/*/*.changes
    @echo "✓ Clean complete"
