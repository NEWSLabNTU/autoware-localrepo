#!/usr/bin/env python3
"""
Autoware Setup Script

This script configures the system after Autoware packages are installed.
It uses modified Ansible playbooks to set up the environment.
"""

import argparse
import os
import sys
import subprocess
import yaml
from pathlib import Path
import logging
from datetime import datetime
import shutil

# Script version
VERSION = "2025.2"

# Paths
SCRIPT_DIR = Path(__file__).parent.resolve()
CONFIG_FILE = Path("/opt/autoware/setup/config.yaml")
ANSIBLE_DIR = Path("/opt/autoware/ansible")
LOG_DIR = Path("/var/log/autoware-setup")

# Colors for output
class Colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKCYAN = '\033[96m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

def print_color(msg, color=Colors.ENDC):
    """Print message with color"""
    print(f"{color}{msg}{Colors.ENDC}")

def print_header(msg):
    """Print section header"""
    print()
    print_color(f"{'=' * 60}", Colors.HEADER)
    print_color(msg, Colors.HEADER + Colors.BOLD)
    print_color(f"{'=' * 60}", Colors.HEADER)
    print()

def setup_logging(verbose=False):
    """Set up logging"""
    LOG_DIR.mkdir(parents=True, exist_ok=True)
    
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    log_file = LOG_DIR / f"setup_{timestamp}.log"
    
    # Create symlink to latest log
    latest_link = LOG_DIR / "latest.log"
    if latest_link.exists():
        latest_link.unlink()
    latest_link.symlink_to(log_file)
    
    # Configure logging
    log_level = logging.DEBUG if verbose else logging.INFO
    logging.basicConfig(
        level=log_level,
        format='%(asctime)s - %(levelname)s - %(message)s',
        handlers=[
            logging.FileHandler(log_file),
            logging.StreamHandler(sys.stdout) if verbose else logging.NullHandler()
        ]
    )
    
    return log_file

def load_config():
    """Load configuration file"""
    if not CONFIG_FILE.exists():
        logging.error(f"Configuration file not found: {CONFIG_FILE}")
        sys.exit(1)
    
    try:
        with open(CONFIG_FILE, 'r') as f:
            config = yaml.safe_load(f)
        return config
    except Exception as e:
        logging.error(f"Failed to load configuration: {e}")
        sys.exit(1)

def check_prerequisites():
    """Check system prerequisites"""
    print_header("Checking Prerequisites")
    
    checks = []
    
    # Check OS version
    try:
        with open('/etc/os-release', 'r') as f:
            os_info = dict(line.strip().split('=', 1) for line in f if '=' in line)
            os_id = os_info.get('ID', '').strip('"')
            os_version = os_info.get('VERSION_ID', '').strip('"')
            
        if os_id == 'ubuntu' and os_version == '22.04':
            checks.append(('Ubuntu 22.04', True, f"✓ {os_id} {os_version}"))
        else:
            checks.append(('Ubuntu 22.04', False, f"✗ {os_id} {os_version}"))
    except:
        checks.append(('Ubuntu 22.04', False, "✗ Could not detect OS"))
    
    # Check if running as root
    if os.geteuid() == 0:
        checks.append(('Not running as root', True, "✓ Running with sudo"))
    else:
        checks.append(('Not running as root', False, "✗ Must run with sudo"))
    
    # Check Ansible
    ansible_path = shutil.which('ansible-playbook')
    if ansible_path:
        checks.append(('Ansible installed', True, f"✓ Found at {ansible_path}"))
    else:
        checks.append(('Ansible installed', False, "✗ ansible-playbook not found"))
    
    # Check Autoware packages
    result = subprocess.run(['dpkg', '-l', 'autoware-full'], 
                          capture_output=True, text=True)
    if result.returncode == 0:
        checks.append(('Autoware packages', True, "✓ autoware-full installed"))
    else:
        checks.append(('Autoware packages', False, "✗ autoware-full not installed"))
    
    # Check disk space
    stat = os.statvfs('/')
    free_gb = (stat.f_bavail * stat.f_frsize) / (1024**3)
    if free_gb > 10:
        checks.append(('Disk space', True, f"✓ {free_gb:.1f} GB free"))
    else:
        checks.append(('Disk space', False, f"✗ Only {free_gb:.1f} GB free"))
    
    # Display results
    all_passed = True
    for name, passed, msg in checks:
        if passed:
            print_color(f"  {msg}", Colors.OKGREEN)
        else:
            print_color(f"  {msg}", Colors.FAIL)
            all_passed = False
    
    if not all_passed:
        print()
        print_color("Prerequisites check failed!", Colors.FAIL)
        sys.exit(1)
    
    print()
    print_color("All prerequisites satisfied!", Colors.OKGREEN)
    return True

def check_nvidia_gpu():
    """Check if NVIDIA GPU is available"""
    try:
        result = subprocess.run(['lspci'], capture_output=True, text=True)
        return 'NVIDIA' in result.stdout
    except:
        return False

def prompt_yes_no(question, default=None):
    """Prompt user for yes/no answer"""
    valid = {"yes": True, "y": True, "no": False, "n": False}
    
    if default is None:
        prompt = " [y/n] "
    elif default:
        prompt = " [Y/n] "
    else:
        prompt = " [y/N] "
    
    while True:
        choice = input(question + prompt).lower()
        if default is not None and choice == '':
            return default
        elif choice in valid:
            return valid[choice]
        else:
            print("Please respond with 'yes' or 'no' (or 'y' or 'n').")

def str_to_bool(value):
    """Convert string to boolean"""
    if isinstance(value, bool):
        return value
    if value.lower() in ('yes', 'true', 't', 'y', '1', 'on'):
        return True
    elif value.lower() in ('no', 'false', 'f', 'n', '0', 'off'):
        return False
    else:
        raise argparse.ArgumentTypeError(f"Boolean value expected, got '{value}'")

def run_ansible_playbook(playbook_path, extra_vars, verbose=False):
    """Run an Ansible playbook"""
    cmd = [
        'ansible-playbook',
        '-i', 'localhost,',
        '-c', 'local',
        str(playbook_path)
    ]
    
    # Add extra variables
    for key, value in extra_vars.items():
        cmd.extend(['-e', f'{key}={value}'])
    
    # Add verbosity
    if verbose:
        cmd.append('-vvv')
    
    # Run playbook
    logging.info(f"Running command: {' '.join(cmd)}")
    
    try:
        result = subprocess.run(cmd, check=True)
        return True
    except subprocess.CalledProcessError as e:
        logging.error(f"Ansible playbook failed with exit code {e.returncode}")
        return False

def verify_installation(args):
    """Verify the installation"""
    print_header("Autoware Installation Verification")
    
    checks = []
    
    # Check ROS 2
    ros_path = Path(f"/opt/ros/{args.rosdistro}")
    if ros_path.exists():
        checks.append(('ROS 2 Installation', True, f"✓ {args.rosdistro} found"))
    else:
        checks.append(('ROS 2 Installation', False, f"✗ {args.rosdistro} not found"))
    
    # Check RMW implementation
    rmw_env = os.environ.get('RMW_IMPLEMENTATION', '')
    if rmw_env == args.rmw_implementation:
        checks.append(('RMW Implementation', True, f"✓ {rmw_env}"))
    else:
        checks.append(('RMW Implementation', False, f"✗ Expected {args.rmw_implementation}, got {rmw_env}"))
    
    # Check data files
    data_dir = Path("/opt/autoware/data")
    if data_dir.exists():
        size_mb = sum(f.stat().st_size for f in data_dir.rglob('*') if f.is_file()) / (1024*1024)
        checks.append(('Data Files', True, f"✓ {size_mb:.1f} MB in {data_dir}"))
    else:
        checks.append(('Data Files', False, "✗ /opt/autoware/data not found"))
    
    # Check services
    result = subprocess.run(['systemctl', 'is-active', 'multicast-lo.service'],
                          capture_output=True, text=True)
    if result.stdout.strip() == 'active':
        checks.append(('Multicast Service', True, "✓ Active"))
    else:
        checks.append(('Multicast Service', False, f"✗ {result.stdout.strip()}"))
    
    # Check NVIDIA if requested
    if args.check_nvidia:
        nvidia_smi = shutil.which('nvidia-smi')
        if nvidia_smi:
            result = subprocess.run(['nvidia-smi', '--query-gpu=name,driver_version', '--format=csv,noheader'],
                                  capture_output=True, text=True)
            if result.returncode == 0:
                gpu_info = result.stdout.strip()
                checks.append(('NVIDIA GPU', True, f"✓ {gpu_info}"))
            else:
                checks.append(('NVIDIA GPU', False, "✗ nvidia-smi failed"))
        else:
            checks.append(('NVIDIA GPU', False, "✗ nvidia-smi not found"))
    
    # Display results
    print("\nSystem Configuration:")
    for name, passed, msg in checks:
        if passed:
            print_color(f"  {msg}", Colors.OKGREEN)
        else:
            print_color(f"  {msg}", Colors.WARNING)
    
    # Overall status
    all_passed = all(passed for _, passed, _ in checks)
    print()
    if all_passed:
        print_color("Overall Status: ✓ Ready for use", Colors.OKGREEN + Colors.BOLD)
    else:
        print_color("Overall Status: ⚠ Some checks failed", Colors.WARNING + Colors.BOLD)
    
    return all_passed

def main():
    """Main function"""
    parser = argparse.ArgumentParser(
        description='Autoware Setup Script',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  %(prog)s                    # Interactive setup
  %(prog)s --nvidia           # Setup with NVIDIA support (same as --nvidia=yes)
  %(prog)s --nvidia=no        # Explicitly disable NVIDIA support
  %(prog)s --dev-tools        # Setup with development tools (same as --dev-tools=yes)
  %(prog)s --dev-tools=no     # Explicitly disable development tools
  %(prog)s --verify           # Verify installation only
  %(prog)s --non-interactive  # Non-interactive with defaults (no NVIDIA, no dev tools)
  %(prog)s --non-interactive --nvidia=yes --dev-tools=no  # Non-interactive with explicit options
        """
    )
    
    parser.add_argument('--version', action='version', version=f'%(prog)s {VERSION}')
    parser.add_argument('--nvidia', nargs='?', const=True, default=None, type=str_to_bool,
                       help='Install NVIDIA CUDA/cuDNN/TensorRT (yes/no)')
    parser.add_argument('--dev-tools', nargs='?', const=True, default=None, type=str_to_bool,
                       help='Install development tools (yes/no)')
    parser.add_argument('--verify', action='store_true', help='Verify installation only')
    parser.add_argument('--verbose', action='store_true', help='Show detailed output')
    parser.add_argument('--non-interactive', action='store_true', help='Run without prompts')
    parser.add_argument('--rosdistro', default='humble', help=argparse.SUPPRESS)
    parser.add_argument('--rmw-implementation', default='rmw_cyclonedds_cpp', help=argparse.SUPPRESS)
    parser.add_argument('--check-nvidia', action='store_true', help=argparse.SUPPRESS)
    
    args = parser.parse_args()
    
    # Set up logging
    log_file = setup_logging(args.verbose)
    logging.info(f"Autoware Setup Script v{VERSION}")
    logging.info(f"Log file: {log_file}")
    
    # Load configuration
    config = load_config()
    
    # Apply defaults from config
    if not args.rosdistro:
        args.rosdistro = config['versions']['rosdistro']
    if not args.rmw_implementation:
        args.rmw_implementation = config['versions']['rmw_implementation']
    
    # Verify mode
    if args.verify:
        args.check_nvidia = args.nvidia or check_nvidia_gpu()
        verify_installation(args)
        return 0
    
    # Check prerequisites
    if os.geteuid() != 0:
        print_color("This script must be run with sudo!", Colors.FAIL)
        sys.exit(1)
    
    check_prerequisites()
    
    # Interactive mode
    if not args.non_interactive:
        print_header("Configuration Options")
        
        # Show current settings
        print("Current configuration:")
        print(f"  ROS Distribution: {Colors.OKCYAN}{args.rosdistro}{Colors.ENDC}")
        print(f"  RMW Implementation: {Colors.OKCYAN}{args.rmw_implementation}{Colors.ENDC}")
        
        # Check for NVIDIA GPU
        if check_nvidia_gpu():
            print(f"  NVIDIA GPU: {Colors.OKGREEN}Detected{Colors.ENDC}")
            if args.nvidia is None:
                args.nvidia = prompt_yes_no("\nInstall NVIDIA CUDA/cuDNN/TensorRT?", default=False)
        else:
            print(f"  NVIDIA GPU: {Colors.WARNING}Not detected{Colors.ENDC}")
            if args.nvidia is None:
                args.nvidia = False
        
        # Developer tools
        if args.dev_tools is None:
            args.dev_tools = prompt_yes_no("\nInstall development tools?", default=False)
        
        # Confirmation
        print("\nSelected options:")
        print(f"  Install NVIDIA: {Colors.OKGREEN if args.nvidia else Colors.WARNING}{'Yes' if args.nvidia else 'No'}{Colors.ENDC}")
        print(f"  Install Dev Tools: {Colors.OKGREEN if args.dev_tools else Colors.WARNING}{'Yes' if args.dev_tools else 'No'}{Colors.ENDC}")
        
        if not prompt_yes_no("\nProceed with installation?", default=True):
            print("Installation cancelled.")
            return 0
    else:
        # Non-interactive mode - set defaults for unspecified options
        if args.nvidia is None:
            args.nvidia = False
        if args.dev_tools is None:
            args.dev_tools = False
    
    # Run Ansible playbook
    print_header("Running Setup")
    
    playbook_path = ANSIBLE_DIR / "playbooks" / "setup.yaml"
    if not playbook_path.exists():
        logging.error(f"Playbook not found: {playbook_path}")
        sys.exit(1)
    
    extra_vars = {
        'install_nvidia': 'true' if args.nvidia else 'false',
        'install_devel': 'true' if args.dev_tools else 'false',
        'rosdistro': args.rosdistro,
        'rmw_implementation': args.rmw_implementation,
        'cuda_version': config['versions']['cuda'],
        'cudnn_version': config['versions']['cudnn'],
        'tensorrt_version': config['versions']['tensorrt'],
    }
    
    print("Running Ansible playbook...")
    success = run_ansible_playbook(playbook_path, extra_vars, args.verbose)
    
    if success:
        print_color("\n✓ Setup completed successfully!", Colors.OKGREEN + Colors.BOLD)
        print("\nNext steps:")
        print("1. Run 'source ~/.bashrc' or start a new terminal")
        print("2. Run 'autoware-setup --verify' to check the installation")
    else:
        print_color("\n✗ Setup failed! Check the logs for details.", Colors.FAIL + Colors.BOLD)
        print(f"Log file: {log_file}")
        sys.exit(1)
    
    return 0

if __name__ == "__main__":
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        print("\n\nSetup interrupted by user.")
        sys.exit(130)
    except Exception as e:
        logging.exception("Unexpected error")
        print_color(f"\nError: {e}", Colors.FAIL)
        sys.exit(1)