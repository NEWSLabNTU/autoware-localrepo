# CLAUDE.md

This file provides guidance to Claude Code when working with this repository.

## Repository Overview

This project builds Debian packages for multiple Autoware versions and creates a local APT repository. It combines:
- **ROS packages** built via colcon2deb (in Docker)
- **Meta-packages** built with debhelper (autoware-config, autoware-theme, autoware-data, autoware-runtime, autoware-full)

## Directory Structure

```
autoware-localrepo/
├── common/autoware-localrepo/    # APT repo configuration package
├── 1.5.0/                        # Autoware 1.5.0 version
│   ├── amd64/                    # colcon2deb build (source/, build/)
│   ├── arm64/                    # colcon2deb build for arm64
│   ├── packages/                 # Debhelper packages
│   │   ├── autoware-config/      # CycloneDDS config, env setup
│   │   ├── autoware-theme/       # RViz theme/icons (uses genpkg.py)
│   │   ├── autoware-data/        # ML models (uses genpkg.py)
│   │   ├── autoware-runtime/     # Meta-package for ROS debs
│   │   └── autoware-full/        # Complete install meta-package
│   ├── output/                   # Consolidated .deb files
│   └── justfile
├── 2025.02/                      # Autoware 2025.02 (same structure)
├── repo/                         # Final APT repository
└── justfile                      # Top-level build automation
```

## Key Commands

### Build Meta-Packages (autoware-config, autoware-theme, etc.)

```bash
# From version directory (e.g., 2025.02/)
just build-packages

# Or individually
cd packages/autoware-config && dpkg-buildpackage -us -uc -b
```

### Build ROS Packages (requires Docker + colcon2deb)

```bash
cd 1.5.0/amd64
just build
```

### Generate Package Files (autoware-data, autoware-theme)

These packages use `genpkg.py` scripts to generate debian/ files and download lists:

```bash
# Regenerate autoware-data debian files
cd packages/autoware-data
python3 genpkg.py --version 2025.02

# Regenerate autoware-theme debian files
cd packages/autoware-theme
python3 genpkg.py --version 2025.02
```

### Create APT Repository

```bash
# From repo root
just create-repo
```

## Package Types

| Package            | Arch | Description                              |
|--------------------|------|------------------------------------------|
| autoware-config    | all  | CycloneDDS config, environment setup     |
| autoware-theme     | all  | RViz icons and Qt theme (from GitHub)    |
| autoware-data      | all  | ML model files (ONNX, etc. from GitHub)  |
| autoware-runtime   | any  | Meta-package depending on ROS packages   |
| autoware-full      | any  | Complete Autoware installation           |
| autoware-localrepo | all  | APT repository configuration             |

## Important Files

### Generated Files (track in git)

These files are generated by genpkg.py but should be committed:
- `packages/autoware-data/downloads.txt` - aria2c download list for ML models
- `packages/autoware-data/tasks.yaml` - Downloaded from Autoware repo
- `packages/autoware-theme/downloads.txt` - aria2c download list for theme files
- `*/amd64/rosdep-packages.txt` - List of rosdep-resolved packages

### Debhelper Packaging

Each package in `packages/` contains standard debian/ directory:
- `debian/control` - Package metadata and dependencies
- `debian/rules` - Build instructions (uses dh)
- `debian/changelog` - Version history
- `debian/compat` or `debian/debhelper-compat` - Debhelper version

### genpkg.py Scripts

`autoware-data/genpkg.py` and `autoware-theme/genpkg.py`:
- Download metadata from Autoware GitHub repository
- Generate `debian/rules` with aria2c parallel download commands
- Generate `downloads.txt` for aria2c input
- Use `$(CURDIR)/debian/<package>/` for install paths (not `$(DESTDIR)`)

## Common Development Tasks

### Adding a New Autoware Version

1. Copy existing version directory structure
2. Update version in `packages/*/debian/changelog`
3. Regenerate package files: `python3 genpkg.py --version <new-version>`
4. Update justfile if needed

### Modifying Package Dependencies

Edit `debian/control` in the respective package directory. For autoware-runtime and autoware-full, update the `Depends:` field.

### Debugging Build Failures

```bash
# Check build logs
cat packages/autoware-config/debian/autoware-config/*.log

# Build with verbose output
DH_VERBOSE=1 dpkg-buildpackage -us -uc -b
```

## Known Issues

### Makefile Heredoc Syntax

Don't use heredoc (`<< 'EOF'`) in debian/rules - it causes "missing separator" errors. Write content to files separately instead.

### Install Path in debian/rules

Always use `$(CURDIR)/debian/<package-name>/` for install destinations, not `$(DESTDIR)/`. Example:
```makefile
install -d $(CURDIR)/debian/autoware-config/opt/autoware/config
```

## Related Projects

- **colcon2deb** (`~/repos/colcon2deb`): Builds ROS packages into .deb files in Docker containers. Used by `*/amd64/` and `*/arm64/` directories.
